# =============================================================================
# GitHub Actions CI/CD Workflow for Cross-Platform Build
# Supports: macOS (Intel + Apple Silicon), Windows
# =============================================================================

name: Cross-Platform Build

on:
  push:
    branches: [main, develop]
    tags: ['v*']
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ==========================================================================
  # Test Job - Run on all platforms
  # ==========================================================================
  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-13, macos-14, windows-latest]
        include:
          - os: macos-13
            platform: macos-intel
          - os: macos-14
            platform: macos-arm64
          - os: windows-latest
            platform: windows

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # macOS-specific setup
      - name: Setup macOS dependencies
        if: startsWith(matrix.os, 'macos')
        run: |
          brew install portaudio ffmpeg
          brew install blackhole-2ch || true

      # Windows-specific setup
      - name: Setup Windows dependencies
        if: matrix.os == 'windows-latest'
        run: |
          choco install ffmpeg

      - name: Install dependencies (macOS ARM64)
        if: matrix.platform == 'macos-arm64'
        run: |
          pip install -r requirements-macos-arm64.txt

      - name: Install dependencies (macOS Intel)
        if: matrix.platform == 'macos-intel'
        run: |
          pip install -r requirements.txt
          pip install torch torchvision torchaudio

      - name: Install dependencies (Windows)
        if: matrix.platform == 'windows'
        run: |
          pip install -r requirements-windows.txt

      - name: Run tests
        run: |
          python -m pytest tests/ -v --cov=src --cov-report=xml

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: ${{ matrix.platform }}
          name: ${{ matrix.platform }}-coverage

  # ==========================================================================
  # Build macOS App (Universal2)
  # ==========================================================================
  build-macos:
    name: Build macOS App
    needs: test
    runs-on: macos-14  # Apple Silicon runner
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          architecture: 'arm64'

      - name: Install dependencies
        run: |
          brew install portaudio ffmpeg create-dmg
          pip install -r requirements-macos-arm64.txt
          pip install py2app

      - name: Build ARM64 binary
        run: |
          python setup.py py2app --arch=arm64

      - name: Build Intel binary (cross-compile)
        run: |
          arch -x86_64 python setup.py py2app --arch=x86_64 --dist-dir=dist-intel

      - name: Create Universal2 binary
        run: |
          # Combine ARM64 and Intel binaries
          mkdir -p dist/VoiceTranslate.app
          # Use lipo to create universal binaries
          # This is a simplified example - actual implementation would be more complex
          echo "Creating Universal2 app bundle..."

      - name: Sign app (if certificate available)
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
        if: env.MACOS_CERTIFICATE != ''
        run: |
          echo "$MACOS_CERTIFICATE" | base64 --decode > certificate.p12
          security create-keychain -p "" build.keychain
          security import certificate.p12 -k build.keychain -P "$MACOS_CERTIFICATE_PWD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" build.keychain
          security find-identity -v -p codesigning build.keychain
          /usr/bin/codesign --force --deep --sign "Developer ID Application" dist/VoiceTranslate.app

      - name: Create DMG
        run: |
          create-dmg \
            --volname "VoiceTranslate Installer" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --app-drop-link 600 185 \
            "VoiceTranslate-${{ github.ref_name }}-macos.dmg" \
            "dist/VoiceTranslate.app"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: VoiceTranslate-*.dmg

      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: VoiceTranslate-*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==========================================================================
  # Build Windows Executable
  # ==========================================================================
  build-windows:
    name: Build Windows Executable
    needs: test
    runs-on: windows-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -r requirements-windows.txt
          pip install pyinstaller

      - name: Build executable
        run: |
          pyinstaller config/voice-translate-windows.spec

      - name: Sign executable (if certificate available)
        env:
          WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
          WINDOWS_CERTIFICATE_PWD: ${{ secrets.WINDOWS_CERTIFICATE_PWD }}
        if: env.WINDOWS_CERTIFICATE != ''
        run: |
          echo "$env:WINDOWS_CERTIFICATE" | Out-File -FilePath certificate.pfx -Encoding Base64
          & "C:\Program Files (x86)\Windows Kits\10\bin\10.0.19041.0\x64\signtool.exe" sign `
            /f certificate.pfx `
            /p "$env:WINDOWS_CERTIFICATE_PWD" `
            /tr http://timestamp.digicert.com `
            /td sha256 `
            /fd sha256 `
            dist/VoiceTranslate.exe

      - name: Create installer (Inno Setup)
        run: |
          # Requires Inno Setup to be installed on runner
          iscc config/installer.iss

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            dist/VoiceTranslate.exe
            dist/VoiceTranslate-Setup.exe

      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            dist/VoiceTranslate.exe
            dist/VoiceTranslate-Setup.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==========================================================================
  # Code Quality Checks
  # ==========================================================================
  quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install linting tools
        run: |
          pip install black flake8 mypy isort

      - name: Check formatting with black
        run: |
          black --check src/ tests/

      - name: Check imports with isort
        run: |
          isort --check-only src/ tests/

      - name: Lint with flake8
        run: |
          flake8 src/ tests/ --max-line-length=100

      - name: Type check with mypy
        run: |
          mypy src/ --ignore-missing-imports
